应用水平扩展的一种尝试

最近尝试应用服务的水平扩展，所谓水平扩展是指可以通过增减应用实例的方式扩展整体的应用性能。比如哪天发现服务器性能不够了，只需要再启动一个应用实例即可，等扛过了流量高峰再关闭一些实例即可。这期间不需要任何其他的设置。  

要实现这样的水平扩展需要最少达到以下两点要求：  
1. 应用无状态(session)或者状态外置
2. 实例自动发现

第一点是为了屏蔽用户对增减服务实例时候的感知。增减服务实例对用户来说是透明的，可能他前面一次的请求是请求的A服务器上面的应用实例，而第二次请求的是B服务器上面的应用实例。此时如果session放在JVM内存里面，用户两次请求的session就不能共享。所以我们需要应用本身就无状态或者将状态外置，例如存储到redis中。这里不同的语言框架有不同的做法，如果是JAVA系，可以参考一下[Spring Session](projects.spring.io/spring-session)，帮我简化了这一过程。  

第二点我这里使用了nginx+confd+redis这样一个搭配来达到nginx dynamic upstream的效果。基本流程就是应用启动的时候向redis注册自己的实例，然后confd会自动读取redis里面的实例然后动态配置nginx并加载。 
